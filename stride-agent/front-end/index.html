<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador STRIDE - Modelo de Amea√ßas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.24.0/dist/cytoscape.min.js"></script>
    <style>
        body { 
            background: #121212; 
            color: #e0e0e0;
        }

        .container { 
            max-width: 1000px; 
            margin-top: 40px; 
            background: #1e1e1e; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.6);
        }

        h2, h5, h6, label { 
            color: #c9a0dc; /* Lil√°s */
        }

        .form-control, .form-select, textarea {
            background: #2a2a2a; 
            color: #f0f0f0; 
            border: 1px solid #444;
        }

        .form-control:focus, .form-select:focus, textarea:focus {
            background: #2e2e2e; 
            border-color: #c9a0dc; 
            color: #fff; 
            box-shadow: 0 0 6px #c9a0dc;
        }

        .btn-primary {
            background-color: #c9a0dc; 
            border-color: #a678c2;
            color: #121212;
        }
        .btn-primary:hover {
            background-color: #a678c2; 
            border-color: #8c5aa8;
            color: #fff;
        }

        .btn-secondary {
            background-color: #444; 
            border: none; 
            color: #c9a0dc;
        }
        .btn-secondary:hover {
            background-color: #555; 
            color: #fff;
        }

        .output-area { 
            background: #1c1c1c; 
            border-radius: 8px; 
            padding: 20px; 
            margin-top: 24px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.6); 
        }

        #cy { 
            width: 100%; 
            height: 600px; 
            margin-top: 24px; 
            border: 1px solid #444; 
            border-radius: 8px; 
            background: #181818;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 class="mb-4">üîé An√°lise de Arquitetura ‚ó¶ Detector de Amea√ßas STRIDE</h2>
    <form id="analyzeForm" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="file" class="form-label">Desenho de Arquitetura (imagem)</label>
            <input class="form-control" type="file" id="imagem" name="imagem" accept="image/*" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Tipo de Aplica√ß√£o</label>
            <input class="form-control" type="text" name="tipo_aplicacao" required>
        </div>
        <div class="mb-3">
            <label class="form-label">M√©todos de Autentica√ß√£o</label>
            <input class="form-control" type="text" name="autenticacao" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Exposta na Internet?</label>
            <select class="form-select" name="acesso_internet" required>
                <option value="Sim">Sim</option>
                <option value="N√£o">N√£o</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Dados Sens√≠veis</label>
            <input class="form-control" type="text" name="dados_sensiveis" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Descri√ß√£o da Aplica√ß√£o</label>
            <textarea class="form-control" name="descricao_aplicacao" rows="3" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Analisar</button>
    </form>

    <div id="output" class="output-area d-none">
        <h5>Resultado</h5>
        <div id="textResult" class="mb-3"></div>
        <h6>Grafo de Amea√ßas (Cytoscape)
            <button id="printGraph" class="btn btn-secondary btn-sm ms-2" type="button">Imprimir Grafo</button>
        </h6>
        <div id="cy"></div>
    </div>
</div>

<script>
const form = document.getElementById('analyzeForm');
const output = document.getElementById('output');
const textResult = document.getElementById('textResult');
const cyContainer = document.getElementById('cy');

form.onsubmit = async (e) => {
    e.preventDefault();
    output.classList.add('d-none');
    textResult.innerHTML = 'Processando...';

    const formData = new FormData(form);
    try {
        const response = await fetch('http://localhost:8001/analisar_ameacas/', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        let texto = data.choices?.[0]?.message?.content || JSON.stringify(data);
        textResult.innerText = texto.trim();

        const cy = cytoscape({
            container: cyContainer,
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': '#c9a0dc',   // lil√°s
                        'label': 'data(label)',
                        'color': '#ffffff',              // texto branco
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-size': '10px',
                        'width': 'label',
                        'height': 'label',
                        'padding': '10px',
                        'border-width': 2,
                        'border-color': '#8c5aa8'       // lil√°s mais escuro
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#888',           
                        'target-arrow-color': '#c9a0dc', 
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'label': 'data(label)',
                        'font-size': '8px',
                        'text-rotation': 'autorotate',
                        'color': '#bbb'
                    }
                },
                {
                    selector: 'node:selected',
                    style: {
                        'background-color': '#a678c2',  
                        'border-color': '#ffffff',
                        'border-width': 3
                    }
                }
            ],
            elements: {
                nodes: [
                    { data: { id: 'Usuario', label: 'Usu√°rio' } },
                    { data: { id: 'EasyAuth', label: 'Easy Auth' } },
                    { data: { id: 'AppService', label: 'App Service' } },
                    { data: { id: 'SQL', label: 'Azure SQL' } },
                    { data: { id: 'EntraID', label: 'Entra ID' } },
                    { data: { id: 'Monitor', label: 'Monitoramento' } },

                    { data: { id: 'Spoofing1', label: 'Spoofing: Token roubado' } },
                    { data: { id: 'Spoofing2', label: 'Spoofing: Conta falsa' } },
                    { data: { id: 'Tampering1', label: 'Tampering: Req. modificada' } },
                    { data: { id: 'Tampering2', label: 'Tampering: Banco alterado' } },
                    { data: { id: 'Repudiation1', label: 'Repudiation: A√ß√£o negada' } },
                    { data: { id: 'Info1', label: 'Disclosure: Vazamento' } },
                    { data: { id: 'DoS1', label: 'DoS: Sobrecarga' } },
                    { data: { id: 'Privilege1', label: 'EoP: Acesso admin' } }
                ],
                edges: [
                    { data: { source: 'Usuario', target: 'EasyAuth', label: 'acessa' } },
                    { data: { source: 'EasyAuth', target: 'AppService', label: 'autoriza' } },
                    { data: { source: 'AppService', target: 'SQL', label: 'consulta' } },
                    { data: { source: 'AppService', target: 'Monitor', label: 'log' } },
                    { data: { source: 'EasyAuth', target: 'EntraID', label: 'identidade' } },

                    { data: { source: 'Spoofing1', target: 'EasyAuth' } },
                    { data: { source: 'Spoofing2', target: 'AppService' } },
                    { data: { source: 'Tampering1', target: 'AppService' } },
                    { data: { source: 'Tampering2', target: 'SQL' } },
                    { data: { source: 'Repudiation1', target: 'AppService' } },
                    { data: { source: 'Info1', target: 'SQL' } },
                    { data: { source: 'DoS1', target: 'AppService' } },
                    { data: { source: 'Privilege1', target: 'AppService' } }
                ]
            },
            layout: {
                name: 'cose',
                padding: 20
            }
        });

        output.classList.remove('d-none');
    } catch (err) {
        textResult.innerText = 'Erro ao processar: ' + err;
        output.classList.remove('d-none');
    }
};

// Bot√£o de impress√£o do grafo
const printBtn = document.getElementById('printGraph');
if (printBtn) {
    printBtn.onclick = function() {
        const cyElement = document.getElementById('cy');
        const printWindow = window.open('', '', 'width=900,height=700');
        printWindow.document.write('<html><head><title>Imprimir Grafo STRIDE</title>');
        printWindow.document.write('<style>body{margin:0;}#cy{width:100vw;height:90vh;}</style>');
        printWindow.document.write('</head><body>');
        const cyCanvas = cyElement.querySelector('canvas');
        if (cyCanvas) {
            const imgData = cyCanvas.toDataURL('image/png');
            printWindow.document.write('<img src="' + imgData + '" style="width:100%;height:auto;"/>');
        } else {
            printWindow.document.write('<div>N√£o foi poss√≠vel capturar o grafo.</div>');
        }
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    };
}
</script>
</body>
</html>

